# ElasticFileSystem.md

## AWSのストレージサービス
おさらい
- ブロックベース
    - Amazon EBS
    - Instance Store
- オブジェクトベース
    - S3
- ファイルベース
    - EFS

## EFS提供状況
- 6/29提供開始
    - バーニジア北部
    - オレゴン
    - アイルランド

## NFSでアクセスできるストレージ
- NFS v4を利用
- Linuxからマウントして利用
- EFSへのアクセスはファイル単位
    - EBSはブロック単位

## ユースケース
- パッケージアプリでS3に対応できないときとか
- 大量のサーバに分散して分析する際に分析データの共有
- コンテンツのリポジトリ
    - AutoscalingするWebサーバ群で画像ファイルを共有
- CDPの「NFS Sharingパターン」が変わる。
    - 元々の注意点
        - NFSサーバの管理が必要
        - NFSアクセスのパフォーマンス苦慮が必要
        - NFSサーバがSPOFになる
    - EFSで解消！！

## EFSの特徴

### 1.シンプル
- フルマネージド型
- 既存のつーるやアプリがそのまま使える
- 保存された合計容量だけの課金

### 2.柔軟・スケーラブル
- 拡張・縮小が必要
    - 1つのファイルシステムにペタバイトまで保存可能
- 性能がスケール
    - 保存容量に応じてスループット・IOPS性能が向上
    - 小容量の時はバースト制

### 3．高耐久性・高可用性
- 複数AZに複製されて保存される
- 複数AZから同時に読み書き可

## EFSの基本

### 管理単位「ファイルシステム」
- 1つのAWSアカウントに複数の「ファイルシステム」を作成

### 接続先「マウントターゲット」
- VPC内の格AZにあるマウントターゲットが接続先
- 各EC2インスタンスからは同じAZにあるマウントターゲットに接続
- DNS、IPアドレスは固定

### セキュリティグループでアクセス制限
- マウントターゲットごとに設定できる
- NACLでのアクセス制限も可能

### パフォーマンスのモード
- GeneralPurposeモード＝一般的なやつ
- MaxI/Oモード＝同時大規模利用。合計スループットを優先してスケールさせるモード。CloudWatchのPercentIOLimitから判断できる。

## 利用するEC2環境
- NFS4.0/4.1をサポートしているLinuxであること
- 古いLinuxカーネルやAMIはだめ。
- Windowsは不可

## EC2上でマウント
- コマンドライン→AZを自動判定
- /etc/fstabへの設定→AZを明示指定
- マウント時のオプション
    - NFS4.1の利用を明示指定が推奨
# 複数EC2から同時アクセス可
- 同じAZ上のEC2からアクセス
- 強い一貫性があり、すべての読み込みは最新のデータが反映されていることを保証
- ファイルのロックが可能（ファイル単位。バイト範囲単位）

## 他サービスとの連携
- CloudWatch
- タグ付け
- IAM
- CloudTrail
- CloudFormation
- Data Pipeline


## パフォーマンス特性
- 内部的に多数のストレージサーバにまたがった分散アーキテクチャ
- メディアデータ処理、遺伝子解析、ビックデータ、並列ジョブ
    - 並列IO・スループット重視で有効
- スループット性能は容量に応じてスケール。小さいときはバースト。
 - 各EC2インスタンスでの性能は最大250MB/sまで、加えてインスタンス性能の上限もあり。ネットワークとかね。

## クレジットの仕組
- 保存しているGBごとに0.05MB/s追加
- 連続12時間バーストまで蓄積可

## スループット性能の例
- 100GB：常時5MB/s以上、1日最大72分間100MB/sまでバースト可

## 比較
値段でいえば、S3が一番安い。
でも、扱い方はファイルとして使えるEBS、EFSの方が楽だけどね。

## 仕様や制限
- プロトコルNFSv4.0/4.1（TCP2049ポート）※CIFSのサポートなし
- 推奨クライアント：現行Linux NFSv4クライアント
- 数量などの制限あり
    - 1台のEC2インスタンスから同時にオープンできるファイル数32,768
    - ファイル名・ディレクトリ名は255倍と、1000階層まで。
    - パフォーマンスモードの変更不可
    - 同一VPC内からのアクセスのみ可。VPCPeeringでもだめ。
    - バックアップ機能、バージョニング機能は未提供
        - 誤削除から守るなら、別途対策が必要
    - サーバサイド暗号化機能は未提供（まもなく提供予定）

# Q&A
- rsyslogdの出力先としてどうなの？
    - 問題ないんじゃないかな。
- S3との違いは？
    - アクセスするプロトコル
- WindowsのNFSクライアントで使えるのでは？
    - 機能的にサポートしていない。
- あやまって削除した時のスナップショットはとれないのか？
    - 機能は提供予定していないので、自分でがんばってね。
- 複数AZへの反映タイムラグは？
    - 読み込むときのタイムラグはない。
- 容量制限をかけることができないか？
    - できない
